#!/bin/bash

echo "üßπ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ PSMO24..."
echo "========================================="

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –í–°–ï –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å psmo24
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã psmo24..."
docker stop $(docker ps -q --filter "name=psmo24") 2>/dev/null || echo "–ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ psmo24"

# –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã psmo24
echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker rm $(docker ps -aq --filter "name=psmo24") 2>/dev/null || echo "–ù–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Å–≤–æ–±–æ–¥–∏–ª–∏ –ø–æ—Ä—Ç 8080
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç 8080..."
if netstat -tlnp | grep :8080 > /dev/null; then
    echo "‚ùó –ü–æ—Ä—Ç 8080 –≤—Å–µ –µ—â–µ –∑–∞–Ω—è—Ç. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏–º–µ–Ω–Ω–æ:"
    netstat -tlnp | grep :8080
    echo "–ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å..."
    sudo fuser -k 8080/tcp 2>/dev/null || echo "–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    echo "‚úÖ –ü–æ—Ä—Ç 8080 —Å–≤–æ–±–æ–¥–µ–Ω"
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º docker-compose –ø—Ä–æ–µ–∫—Ç—ã
echo "üì¶ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ docker-compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
docker-compose down 2>/dev/null || echo "docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω"
docker-compose -f docker-compose.prod.yml down 2>/dev/null || echo "docker-compose.prod.yml —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
docker-compose -f docker-compose.simple.yml down 2>/dev/null || echo "docker-compose.simple.yml –Ω–µ –Ω–∞–π–¥–µ–Ω"

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã..."
docker rmi psmo24_web_php 2>/dev/null || echo "–û–±—Ä–∞–∑ psmo24_web_php –Ω–µ –Ω–∞–π–¥–µ–Ω"
docker rmi psmo24_web 2>/dev/null || echo "–û–±—Ä–∞–∑ psmo24_web –Ω–µ –Ω–∞–π–¥–µ–Ω"
docker rmi $(docker images -q --filter "reference=psmo24*") 2>/dev/null || echo "–î—Ä—É–≥–∏—Ö –æ–±—Ä–∞–∑–æ–≤ psmo24 –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

# –û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã
echo "üßΩ –û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ Docker —Ä–µ—Å—É—Ä—Å—ã..."
docker system prune -f

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é..."
echo "============================="

# –°–æ–∑–¥–∞–µ–º —Å–µ—Ç—å –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
docker network create psmo24_network 2>/dev/null || echo "–°–µ—Ç—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

# –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
echo "üî® –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑..."
docker-compose -f docker-compose.prod.yml build --no-cache

echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose -f docker-compose.prod.yml up -d

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
echo ""
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
echo "====================="
docker-compose -f docker-compose.prod.yml ps

echo ""
echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∞–π—Ç–∞..."
if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 | grep -q "200"; then
    echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:8080"
else
    echo "‚ùå –°–∞–π—Ç –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."
    docker-compose -f docker-compose.prod.yml logs --tail=10
fi

echo ""
echo "üéâ –ì–æ—Ç–æ–≤–æ! –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –∑–∞–ø—É—â–µ–Ω–∞." 